___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "__wm": "VGVtcGxhdGUtQXV0aG9yX0ZhY2Vib29rLVNpbW8tQWhhdmE\u003d",
  "categories": [
    "ADVERTISING",
    "ANALYTICS"
  ],
  "version": 1,
  "securityGroups": [],
  "displayName": "Facebook",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Tag that forwards the event data from the Facebook client to Facebook servers.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "accessToken",
    "displayName": "API Access Token",
    "simpleValueType": true,
    "help": "Set to your Facebook API Access Token. See \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/server-side-api/get-started#access-token\"\u003ehere\u003c/a\u003e for more information.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "LABEL",
    "name": "inheritInstructions",
    "displayName": "If you set the settings in this tag to \u003cstrong\u003eInherit from Client\u003c/strong\u003e, the setting will use whatever information is passed to it from the Client. If you set any field to \u003cstrong\u003eOverride\u003c/strong\u003e, then the field value in this tag will override the corresponding value passed from the Client."
  },
  {
    "type": "SELECT",
    "name": "inheritPixelId",
    "displayName": "Facebook Pixel ID",
    "selectItems": [
      {
        "value": "inherit",
        "displayValue": "Inherit from Client"
      },
      {
        "value": "override",
        "displayValue": "Override"
      }
    ],
    "simpleValueType": true,
    "subParams": [
      {
        "valueValidators": [
          {
            "errorMessage": "You must provide a Pixel ID",
            "type": "NON_EMPTY"
          },
          {
            "args": [
              "^[0-9]+$"
            ],
            "errorMessage": "Invalid Pixel ID format",
            "type": "REGEX"
          }
        ],
        "simpleValueType": true,
        "name": "pixelId",
        "type": "TEXT",
        "valueHint": "e.g. 12345678910",
        "enablingConditions": [
          {
            "paramName": "inheritPixelId",
            "paramValue": "override",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "help": "Set to a valid Facebook Pixel ID. You can only add a single Pixel ID per tag."
  },
  {
    "type": "SELECT",
    "name": "inheritEventName",
    "displayName": "Event Name",
    "selectItems": [
      {
        "value": "inherit",
        "displayValue": "Inherit from Client"
      },
      {
        "value": "override",
        "displayValue": "Override"
      }
    ],
    "simpleValueType": true,
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventName",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "inheritEventName",
            "paramValue": "override",
            "type": "EQUALS"
          }
        ],
        "valueHint": "e.g. AddToCart"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "serverSideGroup",
    "displayName": "Server-Side API Configuration",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "optOut",
        "displayName": "Opt Out (Ads Delivery Optimization)",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from Client"
          },
          {
            "value": true,
            "displayValue": "True"
          },
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "inherit",
        "help": "Set to \u003cstrong\u003etrue\u003c/strong\u003e to only use this hit for attribution and not for ads delivery optimization."
      },
      {
        "type": "SELECT",
        "name": "inheritEventSourceUrl",
        "displayName": "Source URL",
        "selectItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from Client"
          },
          {
            "value": "override",
            "displayValue": "Override"
          }
        ],
        "simpleValueType": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "eventSourceUrl",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "inheritEventSourceUrl",
                "paramValue": "override",
                "type": "EQUALS"
              }
            ]
          }
        ],
        "help": "Leave blank to use the current page URL, or provide a custom URL that Facebook will associate this event with."
      },
      {
        "type": "SELECT",
        "name": "inheritEventId",
        "displayName": "Event ID",
        "selectItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from Client"
          },
          {
            "value": "override",
            "displayValue": "Override"
          }
        ],
        "simpleValueType": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "eventId",
            "simpleValueType": true,
            "valueHint": "abcd-1234",
            "enablingConditions": [
              {
                "paramName": "inheritEventId",
                "paramValue": "override",
                "type": "EQUALS"
              }
            ]
          }
        ],
        "help": "Provide an optional ID that you can use to \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/server-side-api/parameters/server-event#event-id\"\u003ededuplicate between browser and server events\u003c/a\u003e."
      },
      {
        "type": "SELECT",
        "name": "inheritTestId",
        "displayName": "Test ID",
        "selectItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from Client"
          },
          {
            "value": "override",
            "displayValue": "Override"
          }
        ],
        "simpleValueType": true,
        "help": "Provide a Test ID if you want to test server-side events in the Test Events feature of Events Manager.",
        "subParams": [
          {
            "type": "TEXT",
            "name": "testId",
            "simpleValueType": true,
            "valueHint": "TEST123",
            "enablingConditions": [
              {
                "paramName": "inheritTestId",
                "paramValue": "override",
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "dataProcessingOptionsGroup",
    "displayName": "Data Processing Options",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "dpoInfo",
        "displayName": "Data Processing Options force this Facebook event to comply to regional regulations with regard to the processing and selling of user data. Read \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-apis/data-processing-options\"\u003ethis\u003c/a\u003e for more information about how to configure this section."
      },
      {
        "type": "SELECT",
        "name": "inheritDpo",
        "selectItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from Client"
          },
          {
            "value": "ldu",
            "displayValue": "Limited Data Use (LDU)"
          }
        ],
        "simpleValueType": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "dpoCountry",
            "displayName": "Country",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "inheritDpo",
                "paramValue": "ldu",
                "type": "EQUALS"
              }
            ],
            "defaultValue": 0,
            "valueValidators": [
              {
                "type": "NUMBER"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "dpoState",
            "displayName": "State",
            "simpleValueType": true,
            "defaultValue": 0,
            "enablingConditions": [
              {
                "paramName": "inheritDpo",
                "paramValue": "ldu",
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NUMBER"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "displayName": "User Data",
    "name": "userData",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "userDataLabel",
        "displayName": "See \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/server-side-api/parameters/user-data\"\u003ethis documentation\u003c/a\u003e for more details on what user data parameters you can add to the call. If the documentation calls for the parameter to be hashed, you \u003cstrong\u003emust\u003c/strong\u003e hash it with SHA256 or the hit will not be sent to Facebook."
      },
      {
        "type": "SELECT",
        "name": "inheritUserData",
        "selectItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from Client"
          },
          {
            "value": "override",
            "displayValue": "Override"
          }
        ],
        "simpleValueType": true,
        "subParams": [
          {
            "name": "userDataList",
            "simpleTableColumns": [
              {
                "selectItems": [
                  {
                    "displayValue": "City",
                    "value": "ct"
                  },
                  {
                    "displayValue": "Country",
                    "value": "country"
                  },
                  {
                    "displayValue": "Date of Birth",
                    "value": "db"
                  },
                  {
                    "displayValue": "Email",
                    "value": "em"
                  },
                  {
                    "displayValue": "First Name",
                    "value": "fn"
                  },
                  {
                    "displayValue": "Gender",
                    "value": "ge"
                  },
                  {
                    "displayValue": "Last Name",
                    "value": "ln"
                  },
                  {
                    "displayValue": "Phone",
                    "value": "ph"
                  },
                  {
                    "displayValue": "State",
                    "value": "st"
                  },
                  {
                    "displayValue": "Zip Code",
                    "value": "zp"
                  },
                  {
                    "value": "external_id",
                    "displayValue": "External ID"
                  },
                  {
                    "value": "subscription_id",
                    "displayValue": "Subscription ID"
                  },
                  {
                    "value": "lead_id",
                    "displayValue": "Lead ID"
                  },
                  {
                    "value": "fb_login_id",
                    "displayValue": "FB Login ID"
                  }
                ],
                "defaultValue": "",
                "displayName": "Parameter name",
                "name": "name",
                "isUnique": true,
                "type": "SELECT"
              },
              {
                "defaultValue": "",
                "displayName": "Parameter value",
                "name": "value",
                "type": "TEXT"
              }
            ],
            "type": "SIMPLE_TABLE",
            "newRowButtonText": "Add parameter",
            "enablingConditions": [
              {
                "paramName": "inheritUserData",
                "paramValue": "override",
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "displayName": "Object Properties",
    "name": "objectPropertiesGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "SELECT",
        "name": "inheritObjectProperties",
        "selectItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from Client"
          },
          {
            "value": "override",
            "displayValue": "Override"
          }
        ],
        "simpleValueType": true,
        "subParams": [
          {
            "name": "objectPropertyList",
            "simpleTableColumns": [
              {
                "valueValidators": [],
                "defaultValue": "",
                "displayName": "Property Name",
                "name": "name",
                "isUnique": true,
                "type": "TEXT"
              },
              {
                "defaultValue": "",
                "displayName": "Property Value",
                "name": "value",
                "type": "TEXT"
              }
            ],
            "type": "SIMPLE_TABLE",
            "newRowButtonText": "Add property",
            "enablingConditions": [
              {
                "paramName": "inheritObjectProperties",
                "paramValue": "override",
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const encodeUriComponent = require('encodeUriComponent');
const getAllEventData = require('getAllEventData');
const JSON = require('JSON');
const log = require('logToConsole');
const Math = require('Math');
const sendHttpRequest = require('sendHttpRequest');
const setResponseBody = require('setResponseBody');
const setResponseHeader = require('setResponseHeader');
const setResponseStatus = require('setResponseStatus');
const getTimestampMillis = require('getTimestampMillis');

// Helpers

// Guard against undefined values throwing errors when using encodeUriComponent API
const enc = data => {
  data = data || '';
  return encodeUriComponent(data);
};

// Convert snake_case event name to CamelCase.
const lowerCasePartsToStandardEvent = str => {
  return str.split('_').map(s => {
    return s.charAt(0).toUpperCase() + s.slice(1);
  }).join('');
};

// Merge with overriden fields
const mergeWithTagFields = mappedData => {
  if (data.eventName) mappedData.event_name = data.eventName;
  if (data.optOut !== 'inherit') mappedData.opt_out = data.optOut;
  if (data.eventSourceUrl) mappedData.event_source_url = data.eventSourceUrl;
  if (data.eventId) mappedData.event_id = data.eventId;
  if (data.dpoCountry) mappedData.data_processing_options_country = data.dpoCountry;
  if (data.dpoState) mappedData.data_processing_options_state = data.dpoState;
  if (data.userDataList) {
    data.userDataList.forEach(d => {
      mappedData.user_data[d.name] = d.value;
    });
  }
  if (data.objectPropertyList) {
    data.objectPropertyList.forEach(d => {
      mappedData.custom_data = mappedData.custom_data || {};
      mappedData.custom_data[d.name] = d.value;
    });
  }
  return mappedData;
};

const eventData = getAllEventData();
const pixelId = data.pixelId || eventData['x-fb-pixel_id'];
const testId = data.testId || eventData['x-fb-test_event_code'];

const mapFbEvent = fbData => {
  const mappedData = {
    event_name: fbData.event_name !== 'custom_facebook' ? lowerCasePartsToStandardEvent(fbData.event_name) : fbData['x-fb-custom_event'],
    event_time: fbData.timestamp_micros ? Math.floor(fbData.timestamp_micros / 1000) : Math.floor(getTimestampMillis() / 1000),
    user_data: {
      client_ip_address: fbData.user_properties ? fbData.user_properties.ip_address : fbData.ip_override,
      client_user_agent: fbData.user_properties ? fbData.user_properties.user_agent :fbData.user_agent
    },
    data_processing_options: fbData['x-fb-dpo']
  };
  if (fbData.event_id) mappedData.event_id = fbData.event_id;
  if (fbData.page_location) mappedData.event_source_url = fbData.page_location;
  if (fbData['x-fb-opt_out']) mappedData.opt_out = fbData['x-fb-opt_out'];
  if (fbData['x-fb-dpoco']) mappedData.data_processing_options_country = fbData['x-fb-dpoco'];
  if (fbData['x-fb-dpost']) mappedData.data_processing_options_state = fbData['x-fb-dpost'];
  if (fbData['x-fb-custom_data']) mappedData.custom_data = fbData['x-fb-custom_data'];
  if(fbData.user_properties) {
    if (fbData.user_properties.email_address) mappedData.user_data.em = fbData.user_properties.email_address;
    if (fbData.user_properties.phone_number) mappedData.user_data.ph = fbData.user_properties.phone_number;
    if (fbData.user_properties.gender) mappedData.user_data.ge = fbData.user_properties.gender;
    if (fbData.user_properties.date_of_birth) mappedData.user_data.db = fbData.user_properties.date_of_birth;
    if (fbData.user_properties.last_name) mappedData.user_data.ln = fbData.user_properties.last_name;
    if (fbData.user_properties.first_name) mappedData.user_data.fn = fbData.user_properties.first_name;
    if (fbData.user_properties.address.city) mappedData.user_data.ct = fbData.user_properties.address.city;
    if (fbData.user_properties.address.region) mappedData.user_data.st = fbData.user_properties.address.region;
    if (fbData.user_properties.address.post_code) mappedData.user_data.zp = fbData.user_properties.address.post_code;
    if (fbData.user_properties.address.country_code) mappedData.user_data.country = fbData.user_properties.address.country_code;
    if (fbData.user_properties.user_id) mappedData.user_data.external_id = fbData.user_properties.user_id;
  }
  if (fbData['x-fb-fbc']) mappedData.user_data.fbc = fbData['x-fb-fbc'];
  if (fbData['x-fb-fbp']) mappedData.user_data.fbp = fbData['x-fb-fbp'];
  if (fbData['x-fb-subscription_id']) mappedData.user_data.subscription_id = fbData['x-fb-subscription_id'];
  if (fbData['x-fb-login_id']) mappedData.user_data.fb_login_id = fbData['x-fb-login_id'];
  if (fbData['x-fb-lead_id']) mappedData.user_data.lead_id = fbData['x-fb-lead_id'];
  return mergeWithTagFields(mappedData);
};

const apiVersion = '9.0';
const postUrl = 'https://graph.facebook.com/v' + apiVersion + '/' + enc(pixelId) + '/events?access_token=' + enc(data.accessToken);
const postBody = 'data=' + enc(JSON.stringify([mapFbEvent(eventData)])) + '&test_event_code=' + enc(testId);

sendHttpRequest(postUrl, (statusCode, headers, body) => {
  setResponseStatus(statusCode);
  setResponseBody(body);
  data.gtmOnSuccess();
}, {headers: {content_type: 'application/x-www-form-urlencoded'}, method: 'POST', timeout: 500}, postBody);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://graph.facebook.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: HTTP Request sent successfully
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('sendHttpRequest').wasCalledWith(mockUrl, httpResponse, mockOptions, mockBody);
    assertApi('setResponseStatus').wasCalledWith(200);
    assertApi('setResponseBody').wasCalledWith('');
    assertApi('gtmOnSuccess').wasCalled();
- name: HTTP Request sent successfully with custom event
  code: |-
    eventData.event_name = 'custom_facebook';
    eventData['x-fb-custom_event'] = 'MyCustomEventName';
    mappedData.event_name = 'MyCustomEventName';
    mockBody = 'data=' + enc(JSON.stringify([mappedData])) + '&test_event_code=' + enc('test_event_code');

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('sendHttpRequest').wasCalledWith(mockUrl, httpResponse, mockOptions, mockBody);
    assertApi('setResponseStatus').wasCalledWith(200);
    assertApi('setResponseBody').wasCalledWith('');
    assertApi('gtmOnSuccess').wasCalled();
- name: Overridden values sent successfully
  code: |-
    mockData.pixelId = 'new_pixel_id';
    mockData.eventName = 'new_event_name';
    mockData.optOut = 'false';
    mockData.eventSourceUrl = 'https://new-event-source-url.com';
    mockData.eventId = 'new_event_id';
    mockData.testId = 'new_test_id';
    mockData.dpoCountry = 'new_dpo_country';
    mockData.dpoState = 'new_dpo_state';
    mockData.userDataList = [{name: 'ct', value: 'new_ct'}];
    mockData.objectPropertyList = [{name: 'content_type', value: 'new_content_type'}];

    if (mockData.eventName) mappedData.event_name = mockData.eventName;
    if (mockData.optOut !== 'inherit') mappedData.opt_out = mockData.optOut;
    if (mockData.eventSourceUrl) mappedData.event_source_url = mockData.eventSourceUrl;
    if (mockData.eventId) mappedData.event_id = mockData.eventId;
    if (mockData.dpoCountry) mappedData.data_processing_options_country = mockData.dpoCountry;
    if (mockData.dpoState) mappedData.data_processing_options_state = mockData.dpoState;
    if (mockData.userDataList) {
      mockData.userDataList.forEach(d => {
        mappedData.user_data[d.name] = d.value;
      });
    }
    if (mockData.objectPropertyList) {
      mockData.objectPropertyList.forEach(d => {
        mappedData.custom_data = mappedData.custom_data || {};
        mappedData.custom_data[d.name] = d.value;
      });
    }

    const newMockUrl = 'https://graph.facebook.com/v9.0/new_pixel_id/events?access_token=' + enc(mockData.accessToken);
    let newMockBody = 'data=' + enc(JSON.stringify([mappedData])) + '&test_event_code=' + enc('new_test_id');
    const newMockOptions = {headers: {content_type: 'application/x-www-form-urlencoded'}, method: 'POST', timeout: 500};

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('sendHttpRequest').wasCalledWith(newMockUrl, httpResponse, newMockOptions, newMockBody);
    assertApi('setResponseStatus').wasCalledWith(200);
    assertApi('setResponseBody').wasCalledWith('');
    assertApi('gtmOnSuccess').wasCalled();
setup: "const enc = require('encodeUriComponent');\nconst JSON = require('JSON');\n\
  const Math = require('Math');\n\nconst mockData = {\n  accessToken: 'access_token',\n\
  \  inheritPixelId: 'inherit',\n  inheritEventName: 'inherit',\n  optOut: 'inherit',\n\
  \  inheritEventSourceUrl: 'inherit',\n  inheritEventId: 'inherit',\n  inheritTestId:\
  \ 'inherit',\n  inheritDpo: 'inherit',\n  inheritUserData: 'inherit',\n  inheritCustomData:\
  \ 'inherit'\n};\n\nconst eventData = {\n  event_name: 'page_view',\n  timestamp_micros:\
  \ 12345678900,\n  'x-fb-opt_out': true,\n  'x-fb-pixel_id': 'pixel_id',\n  page_location:\
  \ 'https://www.domain.com/',\n  event_id: 'event_id',\n  user_properties: {\n  \
  \  ip_address: '1.2.3.4',\n    user_agent: 'user-agent',\n    address: {}\n  },\n\
  \  'x-fb-login_id': 1234567,\n  'x-fb-custom_data': {\n    content_type: 'product',\n\
  \    currency: 'EUR'\n  },\n  'x-fb-dpo': ['LDU'],\n  'x-fb-dpoco': '0',\n  'x-fb-dpost':\
  \ '0',\n  'x-fb-test_event_code': 'test_event_code'\n};\n\nconst mappedData = {\n\
  \  event_name: 'PageView',\n  event_time: Math.floor(eventData.timestamp_micros\
  \ / 1000),\n  user_data: {\n    client_ip_address: eventData.user_properties.ip_address,\n\
  \    client_user_agent: eventData.user_properties.user_agent\n  },\n  data_processing_options:\
  \ eventData['x-fb-dpo']\n};\nif (eventData.event_id) mappedData.event_id = eventData.event_id;\n\
  if (eventData.page_location) mappedData.event_source_url = eventData.page_location;\n\
  if (eventData['x-fb-opt_out']) mappedData.opt_out = eventData['x-fb-opt_out'];\n\
  if (eventData['x-fb-dpoco']) mappedData.data_processing_options_country = eventData['x-fb-dpoco'];\n\
  if (eventData['x-fb-dpost']) mappedData.data_processing_options_state = eventData['x-fb-dpost'];\n\
  if (eventData['x-fb-custom_data']) mappedData.custom_data = eventData['x-fb-custom_data'];\n\
  if (eventData.user_properties.email_address) mappedData.user_data.em = eventData.user_properties.email_address;\n\
  if (eventData.user_properties.phone_number) mappedData.user_data.ph = eventData.user_properties.phone_number;\n\
  if (eventData.user_properties.gender) mappedData.user_data.ge = eventData.user_properties.gender;\n\
  if (eventData.user_properties.date_of_birth) mappedData.user_data.db = eventData.user_properties.date_of_birth;\n\
  if (eventData.user_properties.last_name) mappedData.user_data.ln = eventData.user_properties.last_name;\n\
  if (eventData.user_properties.first_name) mappedData.user_data.fn = eventData.user_properties.first_name;\n\
  if (eventData.user_properties.address.city) mappedData.user_data.ct = eventData.user_properties.address.city;\n\
  if (eventData.user_properties.address.region) mappedData.user_data.st = eventData.user_properties.address.region;\n\
  if (eventData.user_properties.address.post_code) mappedData.user_data.zp = eventData.user_properties.address.post_code;\n\
  if (eventData.user_properties.address.country_code) mappedData.user_data.country\
  \ = eventData.user_properties.address.country_code;\nif (eventData.user_properties.user_id)\
  \ mappedData.user_data.external_id = eventData.user_properties.user_id;\nif (eventData['x-fb-fbc'])\
  \ mappedData.user_data.fbc = eventData['x-fb-fbc'];\nif (eventData['x-fb-fbp'])\
  \ mappedData.user_data.fbp = eventData['x-fb-fbp'];\nif (eventData['x-fb-subscription_id'])\
  \ mappedData.user_data.subscription_id = eventData['x-fb-subscription_id'];\nif\
  \ (eventData['x-fb-login_id']) mappedData.user_data.fb_login_id = eventData['x-fb-login_id'];\n\
  if (eventData['x-fb-lead_id']) mappedData.user_data.lead_id = eventData['x-fb-lead_id'];\n\
  \nconst mockUrl = 'https://graph.facebook.com/v9.0/pixel_id/events?access_token='\
  \ + enc(mockData.accessToken);\nlet mockBody = 'data=' + enc(JSON.stringify([mappedData]))\
  \ + '&test_event_code=' + enc('test_event_code');\nconst mockOptions = {headers:\
  \ {content_type: 'application/x-www-form-urlencoded'}, method: 'POST', timeout:\
  \ 500};\n\nmock('getAllEventData', () => {\n  return eventData;\n});\n\nlet httpPostUrl,\
  \ httpResponse, httpOptions, httpBody;\nmock('sendHttpRequest', (postUrl, response,\
  \ options, body) => {\n  httpResponse = response;\n  httpBody = body;\n  httpResponse(200,\
  \ {}, '');\n});\n  \n  "


___NOTES___

Created on 18/06/2020, 13:09:58


